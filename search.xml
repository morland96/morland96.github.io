<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[SSH通过跳板机连接服务器]]></title>
      <url>/2017/10/31/ssh-jump/</url>
      <content type="html"><![CDATA[<p>近日在做SDN相关的工作，在使用NCL的相关Testbed，其集群环境是相对封闭的，想要连入每一台机器需要首先连接一台共用跳板机，但这样很不方便。而且跳板机是没有开放ROOT权限的，所以相关的配置，包括转发X11等种种需求都不能很好的实现。</p>
<p>为了解决这种问题，有很多的方案，在查阅了很多网络资料后，我总结了几个我觉得很有帮助的跳板机相关的技巧。</p>
<a id="more"></a>
<h2 id="利用SSH转发端口的能力"><a href="#利用SSH转发端口的能力" class="headerlink" title="利用SSH转发端口的能力"></a>利用SSH转发端口的能力</h2><p>众所周知，SSH具有不错的轻型端口转发能力，甚至是通道能力，这是一个不错的属性，你可以直接通过跳板机直接转发远程主机的端口来满足你的绝大部分需求。比如我们需要连接远程主机的SSH可以直接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh -L 2222:&lt;remote-host&gt;:22  user@&lt;jump-server&gt;</div><div class="line"><span class="meta">#</span> 该命令语法为</div><div class="line"><span class="meta">#</span> ssh -L local-port:remote-address:remote-port user@ssh-host</div></pre></td></tr></table></figure>
<p>即为将remote-host的22端口，通过jump-server转发到本地（运行这条命令的机器）的2222端口</p>
<p>这里需要特别注意的一点是，remote-host是通过jump-server的身份去访问的，也就是说从remote-host角度看起来，所有的请求是由jump-server发起的。另一方面，remote-host的域名解析也是从jump-server的角度发起的，这很有利于集群中，集群的ip已经存储在了jump-server的hosts里的情况。另一方面，如果你想单纯把一台远程主机本体的端口转发到本地，可以直接用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -L local-port:localhost:remote-port user@&lt;ssh-host&gt;</div></pre></td></tr></table></figure>
<p>的方法。因为前面说了，remote-host的域名解析是在这里的ssh-host完成的，所以localhost就是ssh-host本身。</p>
<p>这种方法比较常用于存在防火墙，或者中间有跳板机的时候来转发端口，但是如果只是想通过跳板机登录远程主机，还有更简单的方法</p>
<h2 id="一键通过跳板机连接"><a href="#一键通过跳板机连接" class="headerlink" title="一键通过跳板机连接"></a>一键通过跳板机连接</h2><p>在 <code>~/.ssh/</code> 这个文件夹里面存在着很多与ssh连接有关的配置文件（当然，默认情况下都是不生成的，只有新建后才会有效），比如我们的公私秘钥。同时，你还可以在这个文件夹下面新建config这个文件来配置各种奇葩的ssh连接需求。比如新建 <code>~/.ssh/config</code> 并输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Host &lt;name&gt;</div><div class="line">	User &lt;user&gt;</div><div class="line">	Hostname &lt;host&gt;</div></pre></td></tr></table></figure>
<p>然后直接 <code>ssh &lt;name&gt;</code> 即可连接<code>&lt;user&gt;@&lt;host&gt;</code> 当然既然说他支持很多奇葩设置了，我们就可以用它来完成一键连接跳板机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host &lt;name&gt;</div><div class="line">	User &lt;remote-user&gt;</div><div class="line">	Hostname &lt;remote-host&gt;</div><div class="line">	ProxyCommand ssh &lt;ssh-user&gt;@&lt;ssh-host&gt; nc %h %p 2&gt; /dev/null</div></pre></td></tr></table></figure>
<p>然后直接运行 <code>ssh &lt;name&gt;</code> 即可通过ssh-host作为代理直接连接remote-host，这是非常酸爽的，而且非常的干净，切不影响其他用户的使用（没有想上一个方法一样另起新的端口，并且配置文件仅对当前用户有效）</p>
<p>同时，在进行转发后，你的各种ssh相关的命令，甚至于scp都是可以正常工作的。而对于我，我可以清爽的通过 <code>ssh &lt;name&gt; -X</code> 来清爽的开启一个ssh链接并且启用X11转发。（这里特别指出，如果你先ssh到跳板机，再ssh到远程机器，X11是不能直接转发到你本机的！）</p>
<p>同时这里分享几个小技巧，这几个小技巧都是可以在这种代理链接的方法下正常使用的</p>
<h3 id="挂载网络文件"><a href="#挂载网络文件" class="headerlink" title="挂载网络文件"></a>挂载网络文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sshfs &lt;remote-host&gt;:&lt;file-path&gt; /mnt -o idmap=user</div></pre></td></tr></table></figure>
<p>通过这一条简单的命令，我们就可以把remote-host的file-path挂载到本机的mnt上，同时idmap是为了映射远程机器的用户和本机用户，这是一个很实用的功能</p>
<h3 id="远程文件编辑"><a href="#远程文件编辑" class="headerlink" title="远程文件编辑"></a>远程文件编辑</h3><p>当然，很多时候你只是需要编辑一个远程服务器上的文件。没有问题，vim直接支持通过scp远程编辑文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim scp://&lt;remote-host&gt;/&lt;file-path&gt;</div></pre></td></tr></table></figure>
<p>需要注意的是，在这种情况下，scp会首先把远程文件拷贝到本机的一个tmp目录里面，然后交给vim编辑，并在编辑完成以后再重新拷贝回远程服务器，vim中各种<code>:pwd</code>之类的命令显示的依旧是你本机的信息，这就意味着那些想让vim的各种插件利用远程资源的人可以洗洗睡了（比如自动补全，用的还是你本机的信息）</p>
<h3 id="SSH-SOCK5代理"><a href="#SSH-SOCK5代理" class="headerlink" title="SSH SOCK5代理"></a>SSH SOCK5代理</h3><p>如果上面的各种东西还是让你不爽，你就是想直接访问远程机器的各种资源。好吧，你可以选择直接用SSH开启SOCK5代理，这好像不是啥冷门技能，算是最快速的开代理的方式了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -D 8888 user@host</div></pre></td></tr></table></figure>
<p>这里8888是本机代理端口，用任何sock5的代理软件直接连接 localhost:8888即可。其实很多软件自己就可以访问sock5代理。关于性能，不用很担心，通道类的技术一般来说性能都还过得去，实测表示ssh代理算是非常快的了，毕竟没有那些臃肿的ACL等各种东西，就是个通道+SOCK5，但是这种链接不是很可靠，小用可以，长期请用正经的软件。另外，ssh存在链接超时的问题，网上一搜有很多解决方案。</p>
<p>更多信息，我这里贴个blog <a href="https://blog.tjll.net/ssh-kung-fu/#trivia-ecdsa-keys" target="_blank" rel="external">https://blog.tjll.net/ssh-kung-fu/#trivia-ecdsa-keys</a> ，里面有一些本文没有提到的小技巧，可以看一下。</p>
]]></content>
      
        
        <tags>
            
            <tag> network </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[iRedmail邮件服务器配置]]></title>
      <url>/2017/05/22/iRedmail%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<p>最近研究了一下基于postfix在centos上搭建邮件系统，但是总是遇到各种奇葩的问题。主要还是因为国内blog上面各种无脑复制粘贴的帖子，也没自己去好好测试一下到底能不能用。<br>但是无意中在网上了解到了一个叫做iredmail的基于postfix的整合平台，是一个国人写的开源邮件平台，整合了webmail，后台管理，安全防护等多种特性，并且可以自由选择数据库等所必需的组件。<br><a id="more"></a><br>按照官方文档，成功的在自己的小服务器上安装测试成功，整个系统安装难度低，整合度较高，易用，唯一的缺点就是。。是给全新系统设计的，这就意味着，如果你系统上已经有mysql postfix Amavisd等等服务，估计安装不会那么顺利的进行。建议可以在docker上运行这套环境，或者干脆弄一个全新安装的系统。<br>下面简单的记录一下安装的过程  </p>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><blockquote>
<p>安装步骤主要基于官方文档，有问题可以直接 click-&gt;<a href="http://www.iredmail.com/docs/install.iredmail.on.rhel-zh_CN.html" target="_blank" rel="external">官方安装文档</a></p>
</blockquote>
<h1 id="准备环节"><a href="#准备环节" class="headerlink" title="准备环节"></a>准备环节</h1><p>首先为主机准备一个域名，我直接将自己在阿里云购买的域名（就是你们现在正在看的这个 ‘www.morlanda.top’） 划了一个二级域名 mail.morlanda.top 并且做A解析 mail.morlanda.top到服务器的ip地址，并做MX解析到mail.morlanda.top<br>因为是全新安装，所以在安装时我就给服务器（centos 6.5）制定了本机名为mail.morlanda.top，如果是已有系统可以在<code>/etc/sysconfig/network</code>中修改，如果没有购买域名，可以修改hosts做测试用  </p>
<p>  由于软件本身的限制，我们需要禁用 SELinux。修改<code>/etc/selinux/config</code><br>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  SELINUX=disabled</div><div class="line"><span class="meta">#</span>如果不想直接禁用 可以使用SELINUX=permissive来让系统不强制限制selinux</div><div class="line">  ```  </div><div class="line">  最后检查yum仓库是否为官方默认的，使用阿里云等国内的仓库可能会导致安装失败  </div><div class="line"><span class="meta">#</span>#下载  </div><div class="line">  前往官方下载地址下载最新版本 [官方下载页面](http://www.iredmail.com/download.html)，可以直接右键复制下载链接，然后wget下来，最后直接解压在home目录中</div></pre></td></tr></table></figure></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd ~</div><div class="line">wget https://bitbucket.org/zhb/iredmail/downloads/iRedMail-0.9.5-1.tar.bz2</div><div class="line">tar xjf iRedMail-0.9.5-1.tar.bz2</div></pre></td></tr></table></figure>
<h1 id="执行安装"><a href="#执行安装" class="headerlink" title="执行安装"></a>执行安装</h1><p>  出于某种原因iredmail的网站被GFW给墙了。。。<br>  不过，作者是中国人，能不考虑国情嘛？<br>  直接执行下面命令来启动安装<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">  IREDMAIL_MIRROR=&apos;http://42.159.241.31&apos; bash iRedMail.sh</div><div class="line">#也可以使用IREDMAIL_EPEL_MIRROR=&apos;http://mirrors.aliyun.com/epel&apos;</div></pre></td></tr></table></figure></p>
<p>  稍作等待后（也有可能很~慢）进入安装界面<br>  <img src="http://www.iredmail.com/docs/images/installation/welcome.png" alt=""><br>  这里出现一个选项，让你输入一个邮件存储路径，我直接使用默认值<br>  <img src="http://www.iredmail.com/docs/images/installation/mail_storage.png" alt=""><br>  之后软件会让你连续选择各个需要的组件，比如所用的数据库等。<br>  这个完全取决于个人，那个维护起来方便选那个<br>  我选择了mysql，出于安全考虑，软件随机生成了一个密码，并存入iRedMail.tips文档中<br>  <img src="http://www.iredmail.com/docs/images/installation/first_domain.png" alt=""><br>  输入邮件域名，这里不能是服务器的主机名！！！！！我的主机名是mail.morlanda.top而我的邮件域名是morlanda.top（相当于xxxx@morlanda.top）<br>  这里填错了也不要担心，后面还可以在web管理器里面修改和添加<br>  下面输入密码<br>  <img src="http://www.iredmail.com/docs/images/installation/admin_pw.png" alt=""><br>  选择可选组件（iRedAdmin必选，这是官方提供的网页管理工具，Roundcubemail则是官方提供的webmail程序，如果没有网页邮箱的需求，可以不安装）<br>  <img src="http://www.iredmail.com/docs/images/installation/optional_components.png" alt=""><br>  之后返回shell界面，安装程序会问一连串的问题，均选择y，出了问道是否使用提供的防火墙规则，我选择了否，后面我自己填写了防火墙规则，当然你也可以使用他给提供的防火墙规则<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Would you like to use firewall rules provided by iRedMail now? </div><div class="line">&lt; Question &gt; File: /etc/sysconfig/iptables, with SSHD port: 22. [Y|n]n</div></pre></td></tr></table></figure></p>
<p>  之后安装就顺理成章的完成了，这里需要重启服务器来启动所有的服务，重启后可以根据进入安装文件的目录<code>~/解压的安装包/iRedMail.tips</code>中了解系统管理所需要进入的网页以及对应的密码</p>
<blockquote>
<p>温馨提示：一定要在看过后将iRedMail.tips移动到更安全的地方或者直接记录密码后删除~！！！！！！！      </p>
</blockquote>
<h1 id="安装后工作"><a href="#安装后工作" class="headerlink" title="安装后工作"></a>安装后工作</h1><p>通过地址 <a href="https://mail.morlanda.top/mail/" target="_blank" rel="external">https://mail.morlanda.top/mail/</a> 即可访问系统提供的webmail,<br>通过<a href="https://mail.morlanda.top/iredadmin/" target="_blank" rel="external">https://mail.morlanda.top/iredadmin/</a> 即可访问后台管理系统。   （上述页面均有一个默认管理员账户postmaster@morlanda.top具体可以看iRedMail.tips）<br>网站默认是https的，你可以选择强制关掉它们，但是官方建议你可以去申请一个免费的ssl证书，毕竟https是个非常安全的协议。<br>之后你可以通过后台管理系统添加用户，如果需要批量添加用户，可以参考 <a href="http://www.iredmail.com/docs/sql.bulk.create.mail.users.html" target="_blank" rel="external">官方文档</a> 直接写入到数据库中<br>添加完用户后，可以登录webmail也可以绑定第三方邮件程序测试，我用foxmail进行了测试绑定的是imap服务<br>收件服务器为   <em>mail.morlanda.top</em>  开启ssl，端口为993<br>发件服务器为   <em>mail.morlanda.top</em>  不开启ssl，端口为587<br>更多三方配置参考 <a href="http://www.iredmail.com/docs/index.html#configure-mail-client-applications" target="_blank" rel="external">官方配置</a></p>
<h1 id="注意的问题"><a href="#注意的问题" class="headerlink" title="注意的问题"></a>注意的问题</h1><p>如果仅需内网使用，配置好内网dns即可，如果需要给外网收发邮件，请注意ip地址不能在动态ip黑名单中，不然80%的可能性会被各大邮件运营商退信。   </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>综合体验，iRedMail安装还是很简单的，而且作者还自己建了一个qq群（防止广告嫌疑就不发了，可以在官方中文文档中看到），遇到问题可以在群里问。如果喜欢的话还可以购买pro版，提供杀毒等各种功能外还能得到官方长期技术支持。<br>另外Roundcube webmail的网页邮箱体验还算不错。毕竟是老牌子了，不亚于大部分主流邮箱的体验。作者自己写的后台管理系统偶尔有点小小的显示bug（英文界面下，中文界面出奇的好用），不影响日常使用。  </p>
]]></content>
      
        
        <tags>
            
            <tag> mail </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
